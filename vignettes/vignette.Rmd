---
title: Guide to familial
author: Ryan Thompson
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Guide to familial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 5
)
```

## Introduction

`familal` is an `R` package for testing familial hypotheses as described at [insert link to paper]. Briefly, familial hypotheses about a random variable $X$ are statements of the form:
$$
\begin{split}
&\mathrm{H}_0:\mu(\lambda)=\mu_0\text{ for some }\lambda\in\Lambda \\
&\mathrm{H}_1:\mu(\lambda)\neq\mu_0\text{ for all }\lambda\in\Lambda,
\end{split}
$$
where $\{\mu(\lambda):\lambda\in\Lambda\}$ is a family of population parameters.

Presently, `familial` supports tests for the centers of a distribution via the Huber or trimmed mean families of location parameters. The mean and median are members of both these families. The Huber loss function gives rise to the Huber family:
$$
\ell_\lambda(x,\mu):=
\begin{cases}
\frac{1}{2}\left(\frac{x-\mu}{\sigma}\right)^2 & \text{if } \left|\frac{x-\mu}{\sigma}\right|\leq\lambda \\
\lambda\left|\frac{x-\mu}{\sigma}\right|-\frac{1}{2}\lambda^2 & \text{otherwise},
\end{cases}
$$
where $\lambda\in\Lambda=(0,\infty)$ and $\sigma$ is the scale of $X$. In this case, the familial null hypothesis reads as 'there exists a $\lambda$ such that $\mu(\lambda)$, the population minimizer of the Huber loss function with indexing parameter $\lambda$, is equal to $\mu_0$.' The symmetrically trimmed square loss function gives rise to the trimmed mean family:
$$
\ell_\lambda(x,\mu):=
\begin{cases}
\frac{1}{2}(x-\mu)^2 & \text{if } \lambda\leq F(x)\leq1-\lambda \\
0 & \text{otherwise},
\end{cases}
$$
where $\lambda\in\Lambda=[0,0.5)$ and $F$ is the cumulative distribution function of $X$. The null hypothesis is analogous to that for Huber loss.

The sample counterpart of the parameter $\mu(\lambda)$ is given by
$$
\hat{\mu}(\lambda):=\underset{\mu}{\operatorname{arg~min}}\sum_{i=1}^n\ell_\lambda(x_i,\mu).
$$
`familial` contains algorithms for solving this minimization for all values of $\lambda$ with both of the above loss functions. Consider the brain-to-body weight ratio of mammals in the `mammals` dataset from the `MASS` package. The Huber family is a path that goes from the median at the far left to the mean at the far right.
```{r}
library(familial)
x <- MASS::mammals$brain / MASS::mammals$body
fit <- fit.family(x, family = 'huber')
plot(fit)
```

Now, to test familial hypotheses, `familial` uses the Bayesian bootstrap. Specifically, to bootstrap $\hat{\mu}(\lambda)$, we draw weights $w_1^{(b)},\ldots,w_n^{(b)}$ ($b=1,\ldots,B$) from a uniform Dirichlet distribution and solve
$$
\hat{\mu}^{(b)}(\lambda):=\underset{\mu}{\operatorname{arg~min}}\sum_{i=1}^nw_i^{(b)}\ell_\lambda(x_i,\mu).
$$
We solve the above minimization for all values of $\lambda$ for $b=1,\ldots,B$ and measure the proportions of time that the family contains the null value $\mu_0$. This proportion represents the posterior probability of $H_0$ being true. To map this probability to a decision (accept, reject, or indeterminate), we assign a loss to making an incorrect decision. The decision that minimizes the expected loss under the posterior distribution is the optimal one.

## One-sample tests

Let's demonstrate the functionality of ` familial`. To perform a test of centers with the Huber family, use the `center.test` function with argument `family='huber'` (the default setting). We'll test whether the velocity of galaxies in the `galaxies` dataset is different to 21,000 km/sec.
```{r}
set.seed(1)
x <- MASS::galaxies
test <- center.test(x, mu = 21000)
print(test)
```
The output above shows the posterior probabilities for the events $H_0$ and $H_1$. The 54.2% probability assigned to $H_0$ means that the Huber family contained a center equal to 21,000 km/sec in 54.2% of bootstraps. Because neither of the above probabilities is much larger than the other, the test results in an indeterminate outcome. By default, the function will return an indeterminate result when neither $H_0$ nor $H_1$ have probability at least 0.95. This choice of threshold is analogous to using a frequentist significance level of 0.05.

It is also possible to produce a functional boxplot of the posterior using the `plot` function.
```{r}
plot(test)
```

Rather than specify a null value that is a point, we can specify the null as an interval. Let's now test whether the velocity is between 20,500 km/sec and 21,500 km/sec.
```{r}
center.test(x, mu = c(20500, 21500))
```
The test now accepts $H_0$.

## Two-sample tests

`familial` also supports two-sample testing with paired or independent samples. We'll now test whether the weight of cabbages in the `cabbages` dataset is different between two different cultivars. These samples are independent, so we set `paired = FALSE`.
```{r message = FALSE}
x <- MASS::cabbages[MASS::cabbages$Cult == 'c39', 'HeadWt']
y <- MASS::cabbages[MASS::cabbages$Cult == 'c52', 'HeadWt']

test <- center.test(x, y, paired = FALSE)
print(test)
```
The test rejects $H_0$ that the weight of cabbages is the same.

We can also visualize the posterior differences between the family of each cultivar via a functional boxplot.
```{r}
plot(test)
```

`familial` also supports one-sided tests. Let's test whether family treatment (FT) improves the weight of anorexia patients in the `anorexia` dataset. These samples are paired.
```{r}
x <- MASS::anorexia[MASS::anorexia$Treat == 'FT', 'Postwt']
y <- MASS::anorexia[MASS::anorexia$Treat == 'FT', 'Prewt']

center.test(x, y, alternative = 'greater', paired = TRUE)
```
We again reject $H_0$ that FT does not improve the weight of patients.
